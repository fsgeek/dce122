<!--
# @OSF_COPYRIGHT@
# 
# 
# HISTORY
# $Log: salvage.8dfs,v $
# Revision 1.1.2.5  1996/12/15  22:48:11  wardr
# 	{edit,R1.2.2}
# 	Fixed formatting problems
# 	[1996/12/15  22:47:58  wardr]
#
# Revision 1.1.2.4  1996/11/07  18:57:13  weir
# 	Cleaned up history
# 	[1996/11/07  18:56:59  weir]
# 
# Revision 1.1.2.3  1996/10/28  17:45:53  carrig
# 	{enh,R1.2.2}
# 	Ready for editing
# 	[1996/10/28  17:42:36  carrig]
# 
# Revision 1.1.2.2  1996/10/25  16:48:50  carrig
# 	{enh,R1.2.2}
# 	Fixed VarLists
# 	[1996/10/25  16:48:32  carrig]
# 
# Revision 1.1.2.1  1996/10/22  20:57:31  wardr
# 	{edit,R1.2.2}
# 	Initial checkin after sgml conversion
# 	[1996/10/22  20:52:17  wardr]
# 
# Revision 1.1.1.2  1996/10/22  20:52:17  wardr
# 	{edit,R1.2.2}
# 	Initial checkin after sgml conversion
# 
# $EndLog$
-->
<!---->
<!-- Fragment document type declaration subset:
ArborText, Inc., 1988-1993, v.4001
<!DOCTYPE Book PUBLIC "-//Davenport//DTD DocBook V2.4//EN" [
]>
-->
<RefEntry Id="DFSAGR.MAN179.rsml.1">
<RefMeta>
<RefEntryTitle>salvage</RefEntryTitle>
<ManVolNum>8dfs</ManVolNum>
</RefMeta>
<RefNameDiv>
<RefName><Command>salvage</Command></RefName>
<RefPurpose><Command>salvage</Command> &minus; Uses the DFS Salvager to recover, verify, or salvage the
structure of a DCE LFS aggregate
</RefPurpose>
</RefNameDiv>
<!---->
<!-- COPYRIGHT NOTICE-->
<!-- Copyright (c) 1990, 1991, 1992, 1993 Open Software Foundation, Inc.-->
<!--  Copyright (C) 1989, 1991, 1992, 1993 Transarc Corporation-->
<!-- ALL RIGHTS RESERVED (DCE).  See the file named COPYRIGHT.DCE in the-->
<!-- src directory for the full copyright text.-->
<!---->
<!---->
<!-- HISTORY-->
<!-- Revision 1.1.8.8  1995/07/24  14:15:10  buckler-->
<!-- 	1.1 edits and Prentice Hall reformat-->
<!-- 	[1995/07/24  14:13:29  buckler]-->
<!---->
<!-- Revision 1.1.8.7  1995/07/13  23:01:19  buckler-->
<!-- 	no change-->
<!-- 	[1995/07/13  22:58:53  buckler]-->
<!-- -->
<!-- Revision 1.1.8.6  1994/08/23  19:49:30  jeff-->
<!-- 	Editorial changes.-->
<!-- 	[1994/08/23  19:45:41  jeff]-->
<!-- -->
<!-- Revision 1.1.8.5  1994/08/16  20:24:31  jeff-->
<!-- 	Small editorial tweaks.-->
<!-- 	[1994/08/16  20:23:47  jeff]-->
<!-- -->
<!-- Revision 1.1.8.4  1994/05/19  20:42:24  jeff-->
<!-- 	{defect, 8118, R1.1}-->
<!-- 	Correct use of double quotes.-->
<!-- 	[1994/05/19  20:41:52  jeff]-->
<!-- -->
<!-- Revision 1.1.8.3  1993/10/08  15:04:10  weir-->
<!-- 	Inserted Transarc copyright-->
<!-- 	[1993/10/08  14:59:58  weir]-->
<!-- -->
<!-- Revision 1.1.8.2  1993/08/04  19:01:34  tmw-->
<!-- 	Added index entries for second version of master index.-->
<!-- 	[1993/08/04  18:46:05  tmw]-->
<!-- -->
<!-- Revision 1.1.6.5  1993/02/04  01:42:34  jeff-->
<!-- 	Fix for defects 7023, 6960, 6837, and 4013.-->
<!-- 	[1993/02/04  01:41:20  jeff]-->
<!-- -->
<!-- Revision 1.1.6.4  1993/01/28  02:35:35  dbelch-->
<!-- 	Embedding copyright notice-->
<!-- 	[1993/01/28  00:53:22  dbelch]-->
<!-- -->
<!-- Revision 1.1.6.3  1992/12/03  09:42:22  jeff-->
<!-- 	Fix for defect 5383, correct aggregate command privileges.-->
<!-- 	[1992/12/03  09:42:04  jeff]-->
<!-- -->
<!-- Revision 1.1.6.2  1992/09/10  15:49:40  weir-->
<!-- 	Removed change bar macros; moved into 1.0.2doc tree-->
<!-- 	[1992/09/10  14:29:40  weir]-->
<!-- -->
<!-- Revision 1.1.4.2  1992/09/08  19:10:40  casey-->
<!-- 	Prentice Hall production-->
<!-- 	[1992/09/08  17:01:12  casey]-->
<!-- -->
<!-- Revision 1.1.2.4  1992/07/02  19:21:00  jeff-->
<!-- 	Corrected ACL permissions and small editorial stuff.-->
<!-- 	[1992/07/02  19:19:42  jeff]-->
<!-- -->
<!-- Revision 1.1.2.3  1992/05/20  19:52:39  jeff-->
<!-- 	Corrected referenced OT defect number (3369 to 3669).-->
<!-- 	[1992/05/20  19:31:17  jeff]-->
<!-- -->
<!-- 	Modified existing text and added new text to document the-->
<!-- 	command's new -norecover and -nosalvage options and their-->
<!-- 	functionality.-->
<!-- 	[1992/05/20  19:24:57  jeff]-->
<!-- -->
<!-- Revision 1.1.2.2  1992/05/10  17:52:12  jeff-->
<!-- 	Verified and/or modified italics and other editorial-->
<!-- 	aspects of the file.-->
<!-- 	[1992/05/10  17:46:55  jeff]-->
<!-- -->
<!-- Revision 1.1  1992/01/29  15:54:30  damon-->
<!-- 	Initial revision-->
<!-- -->
<!---->
<!-- (c) Copyright 1991, Open Software Foundation, Inc.  ALL RIGHTS RESERVED-->
<!-- CHANGED-->
<!-- 12-09-91:  In RELATED INFORMATION section, changed SalvageLog(8dfs) to-->
<!--            SalvageLog(4dfs).-->
<!-- END CHANGED-->
<!--DOCUMENTSTYLE [12pt]{book}-->
<IndexTerm Id="DFSAGR.MAN179.indx.1">
<Primary><Command>salvage</Command> command</Primary>
</IndexTerm>
<IndexTerm Id="DFSAGR.MAN179.indx.2">
<Primary>Salvager</Primary>
<Secondary>invoking</Secondary>
</IndexTerm>
<IndexTerm Id="DFSAGR.MAN179.indx.3">
<Primary>aggregates</Primary>
<Secondary>repairing structure</Secondary>
</IndexTerm>
<IndexTerm Id="DFSAGR.MAN179.indx.4">
<Primary>aggregates</Primary>
<Secondary>analyzing structure</Secondary>
</IndexTerm>
<RefSynopsisDiv>
<CmdSynopsis>
<Command>salvage</Command>
<Arg Choice="plain"><Option>aggregate</Option><Replaceable>name</Replaceable></Arg>
<Arg Choice="opt"><Option>recoveronly</Option></Arg>
<Group Choice="opt">
<Group Choice="req">
<Arg Choice="plain"><Option>verifyonly</Option></Arg>
<Arg Choice="plain"><Option>salvageonly</Option></Arg>
</Group>
</Group>
<?Pub _newline>
<Arg Choice="opt"><Option>force</Option></Arg>
<Arg Choice="opt"><Option>verbose</Option></Arg>
<Arg Choice="opt"><Option>help</Option></Arg>
</CmdSynopsis>
</RefSynopsisDiv>
<RefSect1>
<Title>OPTIONS</Title>
<VariableList>
<VarListEntry role="linebreak">
<Term><Option>aggregate</Option> <Symbol Role="Variable">name</Symbol></Term>
<ListItem>
<Para>Specifies the device name or aggregate name of the DCE LFS aggregate to be
verified, recovered, or salvaged.  These names are specified in the first and
second fields of the entry for the aggregate in the
<Symbol Role="Variable">dcelocal</Symbol><Filename>/var/dfs/dfstab</Filename> file.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>recoveronly</Option></Term>
<ListItem>
<Para>Directs the Salvager to recover the specified aggregate.  The Salvager replays
the log of metadata changes that resides on the aggregate.  See the Description
section for information about using and combining the command's options.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>verifyonly</Option></Term>
<ListItem>
<Para>Directs the Salvager to verify the specified aggregate.  The Salvager examines
the structure of the aggregate to determine if it contains any inconsistencies,
reporting any that it finds.  See the Description section for information about
using and combining the command's options.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>salvageonly</Option></Term>
<ListItem>
<Para>Directs the Salvager to salvage the specified aggregate.  The Salvager attempts
to repair any inconsistencies it finds on the aggregate.  See the Description
section for information about using and combining the command's options.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>force</Option></Term>
<ListItem>
<Para>Executes the Salvager in noninteractive mode.  By default, the Salvager prompts
for confirmation before proceeding in certain situations (for example, if it
believes an aggregate on which it is run may be a nonLFS partition).  Use this
option to direct the Salvager to proceed with all operations without asking
whether it should continue.  Use this option with care; the Salvager's changes
can be unpredictable if this option is used with an invalid aggregate.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>verbose</Option></Term>
<ListItem>
<Para>Directs the Salvager to produce detailed information about the aggregate as it
executes.  The information is useful primarily for debugging purposes.  It is
displayed on standard output (which can be redirected).  Use this option alone
or with any combination of the available options.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Option>help</Option></Term>
<ListItem>
<Para>Prints the online help for this command.  All other valid options specified with
this option are ignored.
</Para>
<Para>The <Command>help</Command> and <Literal>apropos</Literal> commands available with all command suites
are also available with the <Command>salvage</Command> command.  See the <Command>bos help</Command> and
<Command>bos apropos</Command> reference pages for examples using these commands.
</Para>
</ListItem>
</VarListEntry>
</VariableList>
</RefSect1>
<RefSect1>
<Title>DESCRIPTION</Title>
<Para>The <Symbol Role="Variable">dcelocal</Symbol><Filename>/bin/salvage</Filename> command invokes the DFS Salvager on the DCE
LFS aggregate specified with the <Option>aggregate</Option> option.  Following a system
restart, the Salvager employs the DCE LFS log mechanism to return consistency
to a file system by running recovery on the aggregate on which the file system
resides.  Recovery is the replaying of the log on the aggregate; the log records
all changes made to metadata as a result of operations such as file creation
and deletion.  If problems are detected in the basic structure of the aggregate,
if the log mechanism is damaged, or if the storage medium of the aggregate is
suspect, the <Command>salvage</Command> command must be used to verify or repair the
structure of the aggregate.
</Para>
<Para>Use the command's <Option>recoveronly</Option>, <Option>verifyonly</Option>, and <Option>salvageonly</Option>
options to indicate the operations the Salvager is to perform on the specified
aggregate, as follows:
<!--no-op:  l-->
</Para>
<ItemizedList>
<ListItem>
<Para>Specify the <Option>recoveronly</Option> option
to run recovery on the aggregate without attempting to find or repair any
inconsistencies found on it.  Recovery is the replaying of the log on the
aggregate.  Use this option to quickly return consistency to an aggregate that
does not need to be salvaged; this represents the normal production use of the
Salvager.  Unless the contents of the log or the physical structure of the
aggregate is damaged, replaying the log is an effective guarantee of a file
system's integrity.
</Para>
</ListItem>
<ListItem>
<Para>Specify the <Option>verifyonly</Option> option
to determine whether the structure of the aggregate contains any
inconsistencies without running recovery or attempting to repair any
inconsistencies found on the aggregate.  Use this option to assess the extent
of the damage to an aggregate.  The Salvager makes no modifications to an
aggregate during verification.  Note that it is normal for the Salvager to
find errors when it verifies an aggregate that has not been recovered; the
presence of an unrecovered log on an aggregate makes the findings of the
Salvager, positive or negative, of dubious worth.
<?sml-break><?sml-need 15></Para>
</ListItem>
<ListItem>
<Para>Specify the <Option>recoveronly</Option> and <Option>verifyonly</Option> options
to run recovery on the aggregate and then analyze its structure without
attempting to repair any inconsistencies found on it.  Use these options if
you believe replaying the log can return consistency to the aggregate, but
you want to verify the consistency of the aggregate after recovery is run.
Recovering an aggregate and then verifying its structure represents a cautious
application of the Salvager.
</Para>
</ListItem>
<ListItem>
<Para>Specify the <Option>salvageonly</Option> option
to attempt to repair any inconsistencies found in the structure of the
aggregate without first running recovery on it.  Use this option if you believe
the log is damaged or replaying the log will not return consistency to the
aggregate and may in fact further damage it.  Under normal circumstances, do not
salvage an aggregate without first recovering it.
</Para>
</ListItem>
<ListItem>
<Para>Omit the <Option>recoveronly</Option>, <Option>verifyonly</Option>, and <Option>salvageonly</Option> options
to run recovery on the aggregate and then attempt to repair any inconsistencies
found in the structure of the aggregate.  Because recovery eliminates
inconsistencies in an undamaged file system, an aggregate is typically
recovered before it is salvaged.  In general, it is good first to recover and
then to salvage an aggregate if a machine panics or experiences a hardware
failure.
</Para>
<Para>Omit these three options if you believe the log should be replayed before
attempts are made to repair any inconsistencies found on the aggregate.
(Omitting the three options is equivalent to specifying the <Option>recoveronly</Option>
and <Option>salvageonly</Option> options.)
</Para>
</ListItem>
</ItemizedList>
<!--no-op:  b-->
<Para>The following rule summarizes the interaction of the <Option>recoveronly</Option>,
<Option>verifyonly</Option>, and <Option>salvageonly</Option> options: The <Command>salvage</Command> command
runs recovery on an aggregate and attempts to repair it <Replaceable>unless</Replaceable> one of
the three options is specified; once one of these options is specified, you
must explicitly request any operation you want the Salvager to perform on the
aggregate.
</Para>
<Para>The basic function of the Salvager is similar to that of the UNIX <Command>fsck</Command>
program.  The Salvager recovers a DCE LFS aggregate and repairs problems it
detects in the structure of the aggregate.  It does not verify or repair the
format of user data contained in files on the aggregate.  If it makes changes,
the Salvager displays the pathnames of the files affected by the modifications,
when the pathnames can be determined.  The owners of the files can then verify
the files' contents, and the files can be restored from backups if necessary.
</Para>
<Para><?sml-need 10>The Salvager verifies the structure of an aggregate by examining all of the
anodes, directories, and other metadata in each fileset on the aggregate.  An
anode is an area on the disk that provides information used to locate data
such as files, directories, ACLs, and other types of file system objects.  Each
fileset contains an arbitrary number of anodes, all of which must reside on
the same aggregate.  By following the links between the various types of anodes,
the Salvager can determine whether the organization of an aggregate and the
filesets it contains is correct and make repairs if necessary.
</Para>
<Para>Not all aggregates can be salvaged.  In cases of extensive damage to the
structure of the metadata on an aggregate or damage to the physical disk that
houses an aggregate, the Salvager cannot repair inconsistencies.  Also, the
Salvager cannot verify or repair damage to user data on an aggregate.  The
Salvager cannot detect problems that modified the contents of a file but did
not damage the structure of an aggregate or change the metadata of the
aggregate.
</Para>
<Para>Like the UNIX <Command>fsck</Command> command, the Salvager analyzes the consistency of
an aggregate by making successive passes through the aggregate.  With each
successive pass, the Salvager examines and extracts a different type of
information from the blocks and anodes on the aggregate.  Later passes of the
Salvager use information found in earlier passes to help in the analysis.
</Para>
<Para>Unlike the <Command>fsck</Command> command, the Salvager does not normally prompt for
additional information as it executes.  It typically performs the requested
operation without prompting for input or pausing to verify any changes before
it makes them.  It prompts for confirmation only in the following cases:
<!--no-op:  l-->
</Para>
<ItemizedList>
<ListItem>
<Para>It believes the specified aggregate does not contain a DCE LFS file system.
This can occur if it finds a nonLFS superblock whose creation time is more
recent than the creation time of the DCE LFS superblock.
</Para>
</ListItem>
<ListItem>
<Para>It finds that the size of the aggregate recorded in the DCE LFS superblock
exceeds the capacity of the partition on which the aggregate resides.
</Para>
</ListItem>
</ItemizedList>
<!--no-op:  b-->
<Para>At the prompt, you can choose to cancel or continue the operation.  If you
continue the operation under either of these circumstances and the aggregate
proves to be invalid, unpredictable results can ensue.  The best response in
either case is to cancel the operation and attempt to determine the cause of
the problem.
</Para>
<Para>If you are confident that you want the Salvager to continue in any case, you
can include the <Option>force</Option> option with the command.  This option directs the
Salvager to perform the requested operation without prompting for confirmation.
Exercise caution when using the <Option>force</Option> option; the Salvager can produce
unpredictable results if this option is used with an invalid aggregate.
</Para>
<Para><?sml-need 10>In general, the Salvager exits with an error code of at least <Literal>16</Literal> without
analyzing a partition that it is sure is not a DCE LFS aggregate.  It also
exits with an error code of <Literal>16</Literal> if an aggregate to be recovered or salvaged is
currently exported to the global namespace, or if a fileset on the aggregate
to be recovered or salvaged is mounted locally. (If necessary, you can use the
<Command>dfsexport</Command> command to detach an exported aggregate from the namespace.)
</Para>
<Para>As the Salvager executes, it maintains a number of internal lists.  Each list
consists of anodes that failed verification in specific ways.  When it initially
scans an aggregate, the Salvager marks as "unsafe" anodes with which it
encounters problems.  The Salvager later attempts to determine the actual
pathnames associated with these anodes to include the pathnames in the lists.
When it has finished salvaging, the Salvager displays any nonempty lists.  It
also returns one of a number of informative exit codes, depending on the
inconsistencies it found and the repairs it made.  More information about the
lists and exit codes displayed by the Salvager appears later in this reference
page.
</Para>
<Para>Internal structures maintained by the Salvager require a minimum of 1 megabyte
of swap space.  However, the total amount of swap space required by the Salvager
depends largely on the size of the aggregate being salvaged and the extent of
the damage to the aggregate.
</Para>
<RefSect2>
<Title>Privilege Required</Title>
<Para>The privileges required depend on whether the <Option>recoveronly</Option>,
<Option>verifyonly</Option>, or <Command>salvageonly</Command> option is specified with the command:
If just the <Option>verifyonly</Option> option is included, the issuer needs only the
read permission for the specified device (aggregate); if the <Option>recoveronly</Option>
or <Option>salvageonly</Option> option is included, or if all three of these options are
omitted, the issuer must have both the read and write permissions for the
specified device.  An issuer who is logged in as <Literal>root</Literal> on the machine on
which the specified device resides always has the necessary privilege to issue
the command.
</Para>
</RefSect2>
</RefSect1>
<RefSect1>
<Title>CAUTIONS</Title>
<Para>The Salvager can be used to salvage only DCE LFS aggregates.  If it is executed
on a nonLFS partition, it exits with an error code of at least <Literal>16</Literal> without
performing any operations.  Use the UNIX <Command>fsck</Command> program or its equivalent
to verify or restore consistency to nonLFS disk partitions.
</Para>
<Para>By default, the Salvager asks for confirmation before proceeding with
operations on aggregates that it suspects are nonLFS partitions or whose
indicated sizes exceed the capacities of the partitions on which they reside.
The command's <Option>force</Option> option can be used to direct the Salvager to
continue without prompting in these cases.  Do not include the <Option>force</Option>
option under normal conditions; the Salvager can make undesirable changes if
the option is used with an invalid aggregate.
</Para>
<Para><?sml-need 10>If the Salvager is used to recover or salvage an aggregate that is currently
exported, it exits with an error code of <Literal>16</Literal> without performing the operation.
Use the <Command>dfsexport</Command> command to detach an aggregate from the global
namespace if necessary before recovering or salvaging it. (The Salvager can
be used to verify the structure of a currently exported aggregate, but this
is not a good practice; the results may be misleading.) The Salvager also
exits with an error code of <Literal>16</Literal> if a fileset on an aggregate to be recovered
or salvaged is mounted locally.
</Para>
</RefSect1>
<RefSect1>
<Title>OUTPUT</Title>
<Para>The Salvager sends output to both <Literal>stdout</Literal> and <Literal>stderr</Literal>.  When it is
started, the Salvager displays the device name of the aggregate on which it is
run and the operation it is to perform.  For example, the Salvager displays the
following message if it is directed to recover an aggregate:
</Para>
<InformalExample>
<Para><ProgramListing>Will run recovery on <Symbol Role="Variable">device</Symbol>
</ProgramListing></Para>
</InformalExample>
<Para>Similarly, the Salvager displays the following message if it is directed to
verify an aggregate:
</Para>
<InformalExample>
<Para><ProgramListing>Verifying <Symbol Role="Variable">device</Symbol>
</ProgramListing></Para>
</InformalExample>
<Para>If you specify the <Option>verbose</Option> option with the command, the Salvager
generates the following information about the aggregate:
<!--no-op:  l-->
</Para>
<ItemizedList>
<ListItem>
<Para>Physical information about the configuration of the aggregate
</Para>
</ListItem>
<ListItem>
<Para>Header information from the aggregate, including the major and minor number of
the device on which the aggregate was created, and the date and time at which
the aggregate was created
</Para>
</ListItem>
<ListItem>
<Para>Information about how space in the aggregate is allocated, including 
</Para>
<ItemizedList>
<ListItem>
<Para>The total size of the aggregate in blocks
</Para>
</ListItem>
<ListItem>
<Para>The block size
</Para>
</ListItem>
<ListItem>
<Para>The fragment size
</Para>
</ListItem>
<ListItem>
<Para>The number of the first block in the aggregate
</Para>
</ListItem>
<ListItem>
<Para>The location of the principal superblock for the aggregate
</Para>
</ListItem>
<ListItem>
<Para>The number of logical blocks in the aggregate
</Para>
</ListItem>
</ItemizedList>
</ListItem>
</ItemizedList>
<!--no-op:  b-->
<Para><?sml-need 15>If you use the Salvager to recover an aggregate and the log on the aggregate
does not need to be replayed, the Salvager displays only the introductory
message described previously.  If the log does need to be replayed and the
Salvager can successfully recover the aggregate, the Salvager displays the
following messages:
</Para>
<InformalExample>
<Para><ProgramListing>Recovery statistics
 &ensp;&ensp;<Symbol Role="Variable">statistics</Symbol>
Ran recovery on <Symbol Role="Variable">device</Symbol>
</ProgramListing></Para>
</InformalExample>
<Para>In the output, <Symbol Role="Variable">statistics</Symbol> consists of a few lines of information about
the log and its replaying, and <Symbol Role="Variable">device</Symbol> is the device name of the
aggregate.  If it cannot run recovery for any reason, the Salvager displays an
appropriate exit code.  (All Salvager exit codes are listed at the end of this
section.)
</Para>
<Para>The Salvager can display much more output if it is asked to verify or salvage
an aggregate on which it finds metadata errors.  As it verifies or salvages a
damaged aggregate, it displays a message similar to the following for each
fileset in which it encounters metadata problems:
</Para>
<InformalExample>
<Para><ProgramListing>In volume <Symbol Role="Variable">fileset</Symbol> (avl #<Symbol Role="Variable">integer</Symbol>)
 &ensp;&ensp;in anode (#<Symbol Role="Variable">integer</Symbol>)
 &ensp;&ensp;&ensp;&ensp;&ensp;<Symbol Role="Variable">description</Symbol>
</ProgramListing></Para>
</InformalExample>
<Para>It displays the first line once for each fileset, repeating the second and
third lines once for each problem anode in the fileset.  The output provides
the following information:
</Para>
<VariableList>
<VarListEntry>
<Term><Symbol Role="Variable">fileset</Symbol></Term>
<ListItem>
<Para>The name and ID number of each affected fileset.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Literal>avl #</Literal><Symbol Role="Variable">integer</Symbol></Term>
<ListItem>
<Para>A pointer to the anode for the fileset.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term><Literal>in anode (#</Literal><Symbol Role="Variable">integer</Symbol><Literal>)</Literal></Term>
<ListItem>
<Para>A pointer to the anode for a file or other object in the fileset.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Symbol Role="Variable">description</Symbol></Term>
<ListItem>
<Para>A brief description of the problem the Salvager found with the anode.  If it
was used to salvage the aggregate, the Salvager also describes any actions it
took to repair the anode.
</Para>
</ListItem>
</VarListEntry>
</VariableList>
<Para>When it has finished executing, the Salvager lists each file whose metadata
it found to be damaged, many of which it likely repaired if it salvaged the
aggregate.  For each file, it displays a line of the form
</Para>
<InformalExample>
<Para><ProgramListing role="page-wide"><Symbol Role="Variable">condition</Symbol> &ensp;&ensp;<Symbol Role="Variable">fileset</Symbol>:<Symbol Role="Variable">pathname</Symbol> volume index: <Symbol Role="Variable">integer</Symbol> anode index: <Symbol Role="Variable">integer</Symbol>
</ProgramListing></Para>
</InformalExample>
<Para>The output provides the following information:
</Para>
<VariableList>
<VarListEntry>
<Term><Symbol Role="Variable">condition</Symbol></Term>
<ListItem>
<Para>A string that describes the state of the file or its metadata. (Information
about the possible conditions follows this list.)
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Symbol Role="Variable">fileset</Symbol></Term>
<ListItem>
<Para>The name of the fileset in which the affected file resides.  In some cases, the
Salvager cannot determine the fileset name.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Symbol Role="Variable">pathname</Symbol></Term>
<ListItem>
<Para>The pathname of the file, relative to the root directory of the fileset.  In
some cases, the Salvager cannot reconstruct the pathname for a file.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term><Literal>volume index</Literal></Term>
<ListItem>
<Para>A pointer to the anode for the fileset. (This information can be used to
identify earlier message displayed by the Salvager that are related to this
file.)
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Literal>anode index</Literal></Term>
<ListItem>
<Para>A pointer to the anode for the file. (This information can be used to identify
earlier message displayed by the Salvager that are related to this file.)
</Para>
</ListItem>
</VarListEntry>
</VariableList>
<Para>The following conditions accompany the files most in need of attention:
</Para>
<VariableList>
<VarListEntry role="linebreak">
<Term><Literal>oughtRestore</Literal></Term>
<ListItem>
<Para>Files in which one or more block references in the associated anode were
removed or changed.  Because it is unlikely such files contain all of their
original data, these files should be restored from existing backups.  This
condition applies only to files on salvaged aggregates.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry>
<Term><Literal>mayRestore</Literal></Term>
<ListItem>
<Para>Files to which modifications were made (for example, files whose ACLs or
property lists were changed).  The owners of these files should verify their
contents, or a system administrator should simply restore them from backups if
a directory listing indicates that they have not been modified since the last
backup was made.  This condition also applies only to files on salvaged
aggregates.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term><Literal>zeroLinkCnt</Literal></Term>
<ListItem>
<Para>Files whose link counts should be 0 (zero).  These files were deleted but not
closed when the system crashed or were orphaned by the Salvager as it made
repairs to the file system.  The system will delete them when the aggregate is
exported.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term><Literal>badLinkCnts</Literal></Term>
<ListItem>
<Para>Files whose link counts were inconsistent with the number of references found
to them.  These files should be examined, if possible, or simply restored.
</Para>
</ListItem>
</VarListEntry>
</VariableList>
<Para>The Salvager can list a file more than once if it determines that multiple
conditions apply to the file.  It can also display one or more additional
conditions (such as <Literal>badAcls</Literal> or <Literal>badPlists</Literal>), but files with which
the additional conditions are associated are typically already covered by one
or more of the conditions just described.  Information in the additional lists
is useful primarily for debugging purposes.
</Para>
<Para>The Salvager also returns one of various exit codes to summarize its actions
and findings.  It returns the exit codes in the form of bits, which it uses to
indicate the state of the aggregate.  It can set multiple bits, but, in general,
the higher the bit, the greater the severity of the aggregate's problems.  (The
higher bit always takes precedence when interpreting the output.)  The Salvager
can return the following exit codes:
</Para>
<VariableList>
<VarListEntry role="linebreak">
<Term>All bits off</Term>
<ListItem>
<Para>The Salvager found no problems.  It displays a message that includes <Literal>Done</Literal>
and <Literal>Checks out</Literal>.  The command need not be run again.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term>First bit (<Literal>0x1</Literal>) set</Term>
<ListItem>
<Para>The Salvager found one or more problems.  It displays a message that includes
<Literal>Done</Literal> and <Literal>Some inconsistencies found</Literal>.  Run the command on the
aggregate without the <Option>verifyonly</Option> option to attempt to correct the
problems.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term>Second bit (<Literal>0x2</Literal>) set</Term>
<ListItem>
<Para>The Salvager found one or more problems and fixed them.  It displays a message
that includes <Literal>Done</Literal> and <Literal>Some inconsistencies repaired</Literal>.  The command
need not be run again. (Note that if the second bit is set, the first bit is
usually also set; because the higher bit takes precedence, you do not need to
run the command again.)
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term>Third bit (<Literal>0x4</Literal>) set</Term>
<ListItem>
<Para>The Salvager found one or more problems and fixed some of them.  It displays a
message that includes <Literal>Incomplete</Literal> and <Literal>Some repairs made</Literal>.  Some
problems were more severe and require a subsequent salvage to be repaired; run
the command on the aggregate without the <Option>verifyonly</Option> option to attempt
to correct the problems.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term>Fourth bit (<Literal>0x8</Literal>) set</Term>
<ListItem>
<Para>The Salvager found the aggregate to be irreparably damaged.  It displays a
message that begins <Literal>Problem</Literal>.  Use the <Command>newaggr</Command> command to
reinitialize the aggregate, and reconstruct the data from existing backups if
possible.
</Para>
</ListItem>
</VarListEntry>
<VarListEntry role="linebreak">
<Term>Fifth bit (<Literal>0x10</Literal>) set</Term>
<ListItem>
<Para>The Salvager found some serious problem that prevents it from running on the
aggregate; for example, the attempted recovery of the aggregate failed because
of damage to the log, or the attempted salvage of the aggregate failed because
the aggregate is not a DCE LFS aggregate, it is currently exported, or it
contains a locally mounted fileset.  The Salvager displays a message that
begins <Literal>Problem</Literal>.  Attempt to determine the cause of the problem.
</Para>
</ListItem>
</VarListEntry>
</VariableList>
<Para>Including the <Option>verbose</Option> option with the command produces more detailed
information about the aggregate as the command executes.  However, the
additional information is useful primarily for debugging purposes.
</Para>
</RefSect1>
<RefSect1>
<Title>EXAMPLES</Title>
<Para>The following command instructs the Salvager to recover the DCE LFS aggregate
whose device name is <Filename>/dev/lv01</Filename>.  This example represents the most-common
application of the Salvager.
</Para>
<InformalExample>
<Para><ProgramListing><UserInput># <Literal>salvage /dev/lv01 -recover</Literal>
</UserInput></ProgramListing></Para>
</InformalExample>
<Para>The following command instructs the Salvager to analyze the structure of the
aggregate to determine if it contains any inconsistencies without running
recovery or attempting to repair the inconsistencies:
</Para>
<InformalExample>
<Para><ProgramListing><UserInput># <Literal>salvage /dev/lv01 -verify</Literal>
</UserInput></ProgramListing></Para>
</InformalExample>
<Para>The following command directs the Salvager to repair any inconsistencies it
finds on the aggregate without first running recovery:
</Para>
<InformalExample>
<Para><ProgramListing><UserInput># <Literal>salvage /dev/lv01 -salvage</Literal>
</UserInput></ProgramListing></Para>
</InformalExample>
</RefSect1>
<RefSect1>
<Title>RELATED INFORMATION</Title>
<!--no-op:  l-->
<Para>Commands:
<Literal>dfsexport(8dfs)</Literal>,
<Literal>newaggr(8dfs)</Literal>.
<!--no-op:  b-->
</Para>
<Para>Files:
<Literal>dfstab(4dfs)</Literal>.
<IndexTerm Id="DFSAGR.MAN179.indx.5" SpanEnd="DFSAGR.MAN179.indx.1"><IndexTerm Id="DFSAGR.MAN179.indx.6" SpanEnd="DFSAGR.MAN179.indx.2"><IndexTerm Id="DFSAGR.MAN179.indx.7" SpanEnd="DFSAGR.MAN179.indx.3"><IndexTerm Id="DFSAGR.MAN179.indx.8" SpanEnd="DFSAGR.MAN179.indx.4"></Para>
</RefSect1>
<!--+ 10/19/96 18:43:16
    | tagMorph:  $Id: salvage.8dfs,v 1.1.2.5 1996/12/15 22:48:11 wardr Exp $
    | tagMorph library:  $Id: salvage.8dfs,v 1.1.2.5 1996/12/15 22:48:11 wardr Exp $
    | sml-to-docbook:  1.23
    +-->
</RefEntry>
